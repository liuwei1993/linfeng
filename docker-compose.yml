# 林风婚恋交友系统 - Docker Compose 配置
# 用法: docker-compose up -d

version: '3.8'

services:
  # 主应用服务
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: linfeng-love-app
    image: linfeng-love:latest
    ports:
      - "8080:8080"
    environment:
      # Spring 环境配置
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_DRUID_DRIVER_CLASS_NAME=com.mysql.cj.jdbc.Driver
      - SPRING_DATASOURCE_DRUID_URL=jdbc:mysql://mysql:3306/linfeng-love-open?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false
      - SPRING_DATASOURCE_DRUID_USERNAME=root
      - SPRING_DATASOURCE_DRUID_PASSWORD=root
      - SPRING_DATASOURCE_DRUID_INITIAL_SIZE=10
      - SPRING_DATASOURCE_DRUID_MAX_ACTIVE=100
      - SPRING_DATASOURCE_DRUID_MIN_IDLE=10
      
      # Redis 配置
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=
      - SPRING_REDIS_DATABASE=0
      
      # RabbitMQ 配置
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - SPRING_RABBITMQ_VIRTUAL_HOST=/
      
      # 应用配置
      - LINFENG_JWT_SECRET=your-jwt-secret-key-here
      - LINFENG_REDIS_OPEN=true
      
      # 微信配置（可选）
      - WX_MA_APPID=your_appid
      - WX_MA_APPSECRET=your_appsecret
      
      # JVM 参数
      - JAVA_OPTS=-Xms512m -Xmx2048m -XX:+UseG1GC
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - linfeng-network
    volumes:
      - ./logs/app:/app/logs
      - ./config:/app/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/swagger-ui.html"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MySQL 数据库
  mysql:
    image: mysql:8.0-debian
    container_name: linfeng-love-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=linfeng-love-open
      - MYSQL_CHARSET=utf8mb4
      - MYSQL_COLLATION=utf8mb4_unicode_ci
      - TZ=Asia/Shanghai
    ports:
      - "3306:3306"
    networks:
      - linfeng-network
    volumes:
      - mysql-data:/var/lib/mysql
      # 可选：导入初始化脚本
      # - ./sql:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone='+08:00'

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: linfeng-love-redis
    ports:
      - "6379:6379"
    networks:
      - linfeng-network
    volumes:
      - redis-data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ 消息队列
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: linfeng-love-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
      - RABBITMQ_DEFAULT_VHOST=/
      - TZ=Asia/Shanghai
    ports:
      - "5672:5672"      # AMQP 端口
      - "15672:15672"    # 管理界面端口
    networks:
      - linfeng-network
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Nginx 反向代理（可选）
  nginx:
    image: nginx:alpine
    container_name: linfeng-love-nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - linfeng-network
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 可选：Adminer 数据库管理工具
  adminer:
    image: adminer:latest
    container_name: linfeng-love-adminer
    ports:
      - "8081:8080"
    networks:
      - linfeng-network
    environment:
      - ADMINER_DEFAULT_SERVER=mysql
    depends_on:
      - mysql
    restart: unless-stopped

  # 可选：MinIO 文件存储（如果不使用云存储）
  minio:
    image: minio/minio:latest
    container_name: linfeng-love-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - linfeng-network
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_BROWSER=on
    volumes:
      - minio-data:/data
    command: minio server /data --console-address ":9001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  linfeng-network:
    driver: bridge
    name: linfeng-network

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  rabbitmq-data:
    driver: local
  minio-data:
    driver: local
  nginx-logs:
    driver: local
